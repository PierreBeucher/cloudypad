services:
 
  # MinIO for S3 backend and client tests
  minio:
    image: minio/minio:RELEASE.2025-09-07T16-13-09Z
    container_name: cloudypad-test-minio
    command: server /data --console-address "0.0.0.0:9001"
    ports:
      - "9010:9000"
      - "9011:9001"
    environment:
      MINIO_ROOT_USER: cloudypad
      MINIO_ROOT_PASSWORD: cloudypad

      # Will instruct Minio to enable virtual host style which is not enable by default otherwise
      # Alternatively we can use S3 client with forcePathStyle: true
      MINIO_DOMAIN: localhost,minio
    
    # Add alises so that minio is reachable via minio and cloudypad.minio hostnames
    # Since S3 client will use virual host style by default and try to reach minio via "<bucket-name>.<hostname>"
    # in our case "cloudypad.minio"
    networks:
      default:
        aliases:
          - cloudypad.minio

    # don't keep data
    tmpfs:
      - /data
      - /certs
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 5s
      timeout: 5s
      retries: 5

  # Initialize MinIO bucket after server startup
  minio-init:
    image: minio/minio:RELEASE.2025-09-07T16-13-09Z
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: 
    - /bin/sh
    - -c
    - >-
      mc alias set local http://minio:9000 cloudypad cloudypad &&
      mc mb --ignore-existing local/cloudypad